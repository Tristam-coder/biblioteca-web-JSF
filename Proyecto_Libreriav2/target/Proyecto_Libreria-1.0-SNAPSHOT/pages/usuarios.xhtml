<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:ui="jakarta.faces.facelets"
      xmlns:p="http://primefaces.org/ui">

    <ui:composition template="/WEB-INF/template.xhtml">
        <ui:define name="titulo">Gestión de Usuarios - Sistema de Biblioteca</ui:define>

        <ui:define name="contenido">
            <!-- Encabezado con breadcrumb -->
            <div class="page-header mb-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><h:link value="Inicio" outcome="/index.xhtml"/></li>
                        <li class="breadcrumb-item active">Usuarios</li>
                    </ol>
                </nav>
                <h1 class="display-6 mb-2">Gestión de Usuarios</h1>
                <p class="lead text-muted">Administración de usuarios, socios y permisos del sistema</p>
            </div>

            <h:form id="formUsuarios">
                <!-- Toolbar -->
                <div style="margin-bottom: 20px;">
                    <p:inputText value="#{usuarioBean.filtro}"
                                 placeholder="Buscar por nombre, email o DNI..."
                                 style="width: 60%; margin-right: 10px;">
                        <p:ajax event="keyup" update="tablaUsuarios" />
                    </p:inputText>

                    <p:commandButton value="Nuevo Usuario" icon="pi pi-plus"
                                     styleClass="ui-button-primary"
                                     action="#{usuarioBean.nuevoUsuario()}"
                                     oncomplete="PF('dlgUsuario').show();"
                                     update="formModal"/>

                    <p:commandButton value="Actualizar" icon="pi pi-refresh"
                                     styleClass="ui-button-info"
                                     action="#{usuarioBean.cargarUsuarios()}"
                                     update="tablaUsuarios"/>
                </div>

                <!-- Tabla de Usuarios -->
                <p:dataTable id="tablaUsuarios"
                             value="#{usuarioBean.usuariosFiltrados}"
                             var="usuario"
                             paginator="true"
                             rows="10"
                             rowsPerPageTemplate="5,10,25,50"
                             emptyMessage="No se encontraron usuarios"
                             styleClass="table-responsive">

                    <p:column headerText="ID" style="width: 50px;">
                        <h:outputText value="#{usuario.id}"/>
                    </p:column>

                    <p:column headerText="DNI">
                        <h:outputText value="#{usuario.dni}"/>
                    </p:column>

                    <p:column headerText="Nombre Completo">
                        <strong>#{usuario.nombre} #{usuario.apellido}</strong>
                    </p:column>

                    <p:column headerText="Email">
                        <h:outputText value="#{usuario.email}"/>
                    </p:column>

                    <p:column headerText="Teléfono">
                        <h:outputText value="#{usuario.telefono}"/>
                    </p:column>

                    <p:column headerText="Tipo">
                        <span class="badge-status #{usuario.tipoUsuario == 'ADMIN' ? 'badge-inactivo' : 'badge-disponible'}">
                            #{usuario.tipoUsuario}
                        </span>
                    </p:column>

                    <p:column headerText="Fecha Registro" sortBy="#{usuario.fechaRegistro}">
                        <h:outputText value="#{usuario.fechaRegistro}">
                            <f:convertDateTime pattern="dd/MM/yyyy" type="localDate"/>
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Estado" sortBy="#{usuario.estado}">
                        <span class="badge-status #{usuario.estado == 'ACTIVO' ? 'badge-activo' : 'badge-inactivo'}">
                            #{usuario.estado}
                        </span>
                    </p:column>

                    <p:column headerText="Acciones" style="width: 150px;">
                        <p:commandButton icon="pi pi-pencil"
                                         styleClass="ui-button-warning ui-button-sm"
                                         title="Editar"
                                         action="#{usuarioBean.editarUsuario(usuario)}"
                                         oncomplete="PF('dlgUsuario').show();"
                                         update="formModal"/>

                        <p:commandButton icon="pi pi-trash"
                                         styleClass="ui-button-danger ui-button-sm"
                                         title="Eliminar"
                                         action="#{usuarioBean.eliminarUsuario(usuario.id)}"
                                         update="tablaUsuarios">
                            <p:confirm header="Confirmación" message="¿Está seguro de eliminar este usuario?"
                                       icon="pi pi-exclamation-triangle"/>
                        </p:commandButton>
                    </p:column>
                </p:dataTable>

                <!-- Confirmación de eliminación -->
                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                    <p:commandButton value="Sí" type="button" styleClass="ui-confirmdialog-yes ui-button-success" icon="pi pi-check"/>
                    <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-secondary" icon="pi pi-times"/>
                </p:confirmDialog>
            </h:form>

            <!-- Modal para Crear/Editar Usuario -->
            <p:dialog id="dlgUsuario" widgetVar="dlgUsuario"
                      header="#{usuarioBean.usuario.id == null ? 'Nuevo Usuario' : 'Editar Usuario'}"
                      modal="true" width="700" resizable="false">
                <h:form id="formModal">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <p:outputLabel for="dni" value="DNI *"/>
                        <p:outputLabel for="email" value="Email *"/>

                        <p:inputText id="dni" value="#{usuarioBean.usuario.dni}"
                                     required="true" requiredMessage="DNI es obligatorio"
                                     pattern="^[0-9]{8}[A-Z]$" validatorMessage="DNI inválido (formato: 12345678A)"
                                     placeholder="12345678A"/>

                        <p:inputText id="email" value="#{usuarioBean.usuario.email}"
                                     required="true" requiredMessage="Email es obligatorio"
                                     type="email" validatorMessage="Email inválido"
                                     placeholder="usuario@ejemplo.com"/>

                        <p:outputLabel for="nombre" value="Nombre *"/>
                        <p:outputLabel for="apellido" value="Apellido *"/>

                        <p:inputText id="nombre" value="#{usuarioBean.usuario.nombre}"
                                     required="true" requiredMessage="Nombre es obligatorio"
                                     placeholder="Juan"/>

                        <p:inputText id="apellido" value="#{usuarioBean.usuario.apellido}"
                                     required="true" requiredMessage="Apellido es obligatorio"
                                     placeholder="Pérez"/>

                        <p:outputLabel for="telefono" value="Teléfono"/>
                        <p:outputLabel for="tipoUsuario" value="Tipo de Usuario *"/>

                        <p:inputText id="telefono" value="#{usuarioBean.usuario.telefono}"
                                     placeholder="612345678"/>

                        <p:selectOneMenu id="tipoUsuario" value="#{usuarioBean.usuario.tipoUsuario}">
                            <f:selectItem itemValue="SOCIO" itemLabel="Socio"/>
                            <f:selectItem itemValue="BIBLIOTECARIO" itemLabel="Bibliotecario"/>
                            <f:selectItem itemValue="ADMIN" itemLabel="Administrador"/>
                        </p:selectOneMenu>
                    </div>

                    <div style="margin-top: 15px;">
                        <p:outputLabel for="direccion" value="Dirección"/>
                        <p:inputTextarea id="direccion" value="#{usuarioBean.usuario.direccion}"
                                         rows="3" placeholder="Calle Principal 123, Madrid"
                                         style="width: 100%; margin-top: 5px;"/>
                    </div>

                    <div style="margin-top: 15px;">
                        <p:outputLabel for="estado" value="Estado *"/>
                        <p:selectOneMenu id="estado" value="#{usuarioBean.usuario.estado}" style="width: 200px; margin-left: 10px;">
                            <f:selectItem itemValue="ACTIVO" itemLabel="Activo"/>
                            <f:selectItem itemValue="INACTIVO" itemLabel="Inactivo"/>
                            <f:selectItem itemValue="SUSPENDIDO" itemLabel="Suspendido"/>
                        </p:selectOneMenu>
                    </div>

                    <div style="margin-top: 20px; text-align: right;">
                        <p:commandButton value="Cancelar" icon="pi pi-times"
                                         styleClass="ui-button-secondary"
                                         onclick="PF('dlgUsuario').hide();" type="button"/>

                        <p:commandButton value="Guardar" icon="pi pi-check"
                                         styleClass="ui-button-success"
                                         action="#{usuarioBean.guardarUsuario()}"
                                         update="formUsuarios:tablaUsuarios"
                                         oncomplete="if(!args.validationFailed){PF('dlgUsuario').hide();}"/>
                    </div>
                </h:form>
            </p:dialog>

        </ui:define>
    </ui:composition>
</html>

