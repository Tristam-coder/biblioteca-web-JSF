<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:b="http://bootsfaces.net/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                template="/template.xhtml">

    <ui:define name="title">Solicitud de Pr√©stamo - Ediciones Saberum</ui:define>

    <ui:define name="content">
        <div class="container py-3">
            <div class="breadcrumb mb-3">
                <b:link value="Inicio" outcome="/index.xhtml"/>
                <span class="mx-2 text-muted">/</span>
                <b:link value="Cat√°logo" outcome="/catalogo.xhtml"/>
                <span class="mx-2 text-muted">/</span>
                <b:link value="Detalle Obra" outcome="/detalle-obra.xhtml"/>
                <span class="mx-2 text-muted">/</span>
                <span class="text-primary">Solicitud Pr√©stamo</span>
            </div>
            
            <b:row>
                <b:column col-lg="12">
                    <h1 class="mb-3">Solicitud de Pr√©stamo</h1>
                    
                    <!-- Wizard Steps -->
                    <div class="wizard-steps mb-4">
                        <div class="steps">
                            <div class="step completed">
                                <div class="step-number">1</div>
                                <div class="step-label">Selecci√≥n</div>
                            </div>
                            <div class="step active">
                                <div class="step-number">2</div>
                                <div class="step-label">Datos del Pr√©stamo</div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-label">Confirmaci√≥n</div>
                            </div>
                        </div>
                    </div>
                    
                    <b:panel title="Datos de la Solicitud" look="primary">
                        <h:form id="loanForm">
                            <b:row>
                                <b:column col-md="6">
                                    <b:inputText label="T√≠tulo de Obra" 
                                               value="#{loanRequestController.libro.titulo}" 
                                               disabled="true"
                                               styleClass="mb-3"/>
                                </b:column>
                                <b:column col-md="6">
                                    <b:inputText label="Autor" 
                                               value="#{loanRequestController.libro.autor}" 
                                               disabled="true"
                                               styleClass="mb-3"/>
                                </b:column>
                            </b:row>
                            
                            <b:row>
                                <b:column col-md="6">
                                    <b:inputText label="ISBN" 
                                               value="#{loanRequestController.libro.isbn}" 
                                               disabled="true"
                                               styleClass="mb-3"/>
                                </b:column>
                                <b:column col-md="6">
                                    <b:inputText label="Fecha Deseada de Retiro" 
                                               type="date" 
                                               value="#{loanRequestController.fechaRetiroString}"
                                               required="true"
                                               requiredMessage="La fecha de retiro es obligatoria"
                                               styleClass="mb-3"
                                               id="fechaRetiroInput"/>
                                </b:column>
                            </b:row>
                            
                            <b:row>
                                <b:column col-md="6">
                                    <b:inputText label="Fecha Estimada de Devoluci√≥n" 
                                               value="#{loanRequestController.fechaDevolucionEstimada}" 
                                               disabled="true"
                                               styleClass="mb-3"/>
                                </b:column>
                                <b:column col-md="6">
                                    <b:selectOneMenu label="Punto de Retiro" 
                                                   value="#{loanRequestController.puntoRetiro}"
                                                   required="true"
                                                   requiredMessage="Seleccione un punto de retiro"
                                                   styleClass="mb-3">
                                        <f:selectItem itemLabel="Seleccione punto de retiro" itemValue=""/>
                                        <f:selectItem itemLabel="üèõÔ∏è Biblioteca Central" itemValue="central"/>
                                        <f:selectItem itemLabel="üìç Sede Norte" itemValue="norte"/>
                                        <f:selectItem itemLabel="üìç Sede Sur" itemValue="sur"/>
                                        <f:selectItem itemLabel="üìç Sede Este" itemValue="este"/>
                                    </b:selectOneMenu>
                                </b:column>
                            </b:row>
                            
                            <h4 class="mt-4 mb-3">Confirmaci√≥n de T√©rminos</h4>
                            <b:selectBooleanCheckbox label="Acepto los t√©rminos y condiciones de pr√©stamo." 
                                                   value="#{loanRequestController.aceptaTerminos}"
                                                   required="true"
                                                   requiredMessage="Debe aceptar los t√©rminos y condiciones"
                                                   styleClass="mb-3"/>
                            
                            <b:row>
                                <b:column>
                                    <div class="terms-box p-3 bg-light rounded mt-2 mb-4">
                                        <h5>T√©rminos y Condiciones del Pr√©stamo:</h5>
                                        <ul class="small mb-0">
                                            <li>El per√≠odo de pr√©stamo es de 15 d√≠as naturales</li>
                                            <li>Se permite una renovaci√≥n por 15 d√≠as adicionales si no hay reservas</li>
                                            <li>Multa por retraso: S/. 1.00 por d√≠a</li>
                                            <li>El usuario es responsable del libro durante el per√≠odo de pr√©stamo</li>
                                            <li>En caso de p√©rdida o da√±o, deber√° reponer el libro</li>
                                            <li>No se permiten subpr√©stamos a terceras personas</li>
                                            <li>Debe presentar DNI al momento del retiro</li>
                                        </ul>
                                    </div>
                                </b:column>
                            </b:row>
                            
                            <!-- Agrega esto al final del formulario, despu√©s de los t√©rminos: -->

                            <!-- ‚úÖ SECCI√ìN DE PAGO (solo se muestra si acepta t√©rminos) -->
                            <!-- SECCI√ìN DE PAGO (manteniendo el dise√±o original) -->
                            <div class="payment-section mt-4" rendered="#{loanRequestController.aceptaTerminos}">
                                <h4 class="mb-3">üí≥ Informaci√≥n de Pago</h4>

                                <b:panel title="Resumen de Costos" look="info">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Costo del pr√©stamo:</strong> <span class="text-success">S/. 5.00</span></p>
                                            <p><strong>Dep√≥sito de garant√≠a:</strong> <span class="text-warning">S/. 20.00</span></p>
                                            <hr/>
                                            <h5 class="text-primary">Total a pagar: <span class="text-success">S/. 25.00</span></h5>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="alert alert-warning small">
                                                <i class="fas fa-info-circle me-2"></i>
                                                El dep√≥sito de S/. 20.00 ser√° reembolsado al devolver el libro en buen estado.
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Botones de Pago - FORMA SIMPLE -->
                                    <div class="text-center mt-4">
                                        <!-- Bot√≥n Proceder al Pago con validaci√≥n -->
                                        <h:form id="pagoForm" style="display: inline;">
                                            <b:commandButton value="üí≥ Proceder al Pago" 
                                                           look="success" 
                                                           size="lg"
                                                           action="#{navigationController.goToPago}"
                                                           styleClass="me-3"
                                                           onclick="if(!confirm('Desea proceder al pago del prestamo? Total: S/. 25.00')) return false;"
                                                          immediate="true"  />
                                        </h:form>
                                    </div>
                                </b:panel>
                            </div>
                            <div class="action-buttons mt-4 d-flex gap-2 flex-wrap">
                                <b:commandButton value="‚Üê Anterior" 
                                          look="outline-secondary" 
                                          action="#{navigationController.goToDetalleObra}"
                                          immediate="true"
                                          styleClass="flex-fill"/>
                                
                                <b:commandButton value="‚Ü∂ Cancelar Todo" 
                                        look="danger" 
                                        action="#{navigationController.goToCatalogo}"
                                        immediate="true"
                                        styleClass="flex-fill"/>
                            </div>
                        </h:form>
                    </b:panel>
                </b:column>
            </b:row>
        </div>
        
        <script>
            // ‚úÖ ESTABLECER FECHA M√çNIMA Y VALOR POR DEFECTO
            document.addEventListener('DOMContentLoaded', function() {
                const hoy = new Date();
                const manana = new Date(hoy);
                manana.setDate(hoy.getDate() + 1);
                
                const fechaInput = document.getElementById('loanForm:fechaRetiroInput');
                if (fechaInput) {
                    // Establecer fecha m√≠nima como hoy
                    fechaInput.min = hoy.toISOString().split('T')[0];
                    
                    // Si no hay valor, establecer ma√±ana como valor por defecto
                    if (!fechaInput.value) {
                        fechaInput.value = manana.toISOString().split('T')[0];
                    }
                }
            });
        </script>
        
    </ui:define>
</ui:composition>